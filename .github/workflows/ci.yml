name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  tier1-userspace-tests:
    name: Tier 1 - Userspace Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Build tests
        run: cd tests && make

      - name: Run tests
        run: cd tests && make test

  tier2-module-build:
    name: Tier 2 - Module Compilation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kernel headers
        run: sudo apt-get update && sudo apt-get install -y linux-headers-$(uname -r) build-essential

      - name: Build kernel module
        run: make modules

      - name: Verify module built
        run: |
          ls -la src/speed_bump.ko
          modinfo src/speed_bump.ko

  userspace-tool:
    name: Build sbctl
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build sbctl
        run: make -C userspace

      - name: Verify sbctl
        run: ./userspace/sbctl --help
